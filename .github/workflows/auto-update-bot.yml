name: Auto Update Bot

on:
  push:
    branches: [ main, develop ]
    paths: 
      - '**'
  release:
    types: [published]

env:
  POCKETBASE_URL: ${{ secrets.POCKETBASE_URL }}
  POCKETBASE_ADMIN_EMAIL: ${{ secrets.POCKETBASE_ADMIN_EMAIL }}
  POCKETBASE_ADMIN_PASSWORD: ${{ secrets.POCKETBASE_ADMIN_PASSWORD }}

jobs:
  build-and-upload:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python 3.13.0
      uses: actions/setup-python@v4
      with:
        python-version: 3.13.0
        architecture: 'x64'
    
    - name: Debug directory structure
      shell: pwsh
      run: |
        Write-Host "Current directory:"
        Get-Location
        Write-Host "Directory contents:"
        Get-ChildItem
        Write-Host "Looking for main.py:"
        if (Test-Path "main.py") {
          Write-Host "✅ main.py found"
        } else {
          Write-Host "❌ main.py not found"
        }
    
    - name: Install dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        if (Test-Path "requirements.txt") {
          pip install -r requirements.txt
        } else {
          Write-Host "⚠️ requirements.txt not found, installing basic dependencies"
        }
        pip install requests pyinstaller
        Write-Host "✅ PyInstaller installed for single-file executable creation"
    
    - name: Get version info
      id: version
      shell: pwsh
      run: |
        if (Test-Path "version.txt") {
          $VERSION = Get-Content "version.txt" -Raw
          $VERSION = $VERSION.Trim()
        } else {
          $COMMIT_HASH = git rev-parse --short HEAD
          $VERSION = "dev-$COMMIT_HASH"
        }
        
        echo "version=$VERSION" >> $env:GITHUB_OUTPUT
        Write-Host "Build version: $VERSION"
        
        $UPDATE_TYPE = "patch"
        echo "update_type=$UPDATE_TYPE" >> $env:GITHUB_OUTPUT
        Write-Host "Update type: $UPDATE_TYPE"
    
    - name: Build Windows EXE
      shell: pwsh
      run: |
        if (Test-Path "main.py") {
          Write-Host "Building EXE from main.py using PyInstaller"
          
          # Create dist directory if it doesn't exist
          New-Item -ItemType Directory -Path "dist" -Force
          
          # Build single file executable with PyInstaller
          pyinstaller --onefile --name "PatrickDisplayBot" --distpath "./dist" main.py
          
          if (Test-Path "./dist/PatrickDisplayBot.exe") {
            Write-Host "✅ EXE build successful"
            Get-ChildItem "./dist/PatrickDisplayBot.exe" | Format-List Name, Length, LastWriteTime
          } else {
            Write-Host "❌ EXE build failed"
            Write-Host "Checking dist directory contents:"
            Get-ChildItem "./dist" -ErrorAction SilentlyContinue
            exit 1
          }
        } else {
          Write-Host "❌ main.py not found"
          exit 1
        }
    
    - name: Create update package
      id: package
      shell: pwsh
      run: |
        $VERSION = "${{ steps.version.outputs.version }}"
        $PACKAGE_NAME = "patrick-display-bot-$VERSION.zip"
        
        Write-Host "Creating update package: $PACKAGE_NAME"
        
        New-Item -ItemType Directory -Path "temp_package" -Force
        Copy-Item -Path "*" -Destination "temp_package/" -Recurse -Exclude @("temp_package", ".git", ".github")
        
        Compress-Archive -Path "temp_package/*" -DestinationPath $PACKAGE_NAME -Force
        
        echo "package_path=$PACKAGE_NAME" >> $env:GITHUB_OUTPUT
        $fileSize = (Get-Item $PACKAGE_NAME).Length / 1MB
        Write-Host "Package created: $PACKAGE_NAME ($($fileSize.ToString('F2')) MB)"
    
    - name: Upload to PocketBase
      shell: pwsh
      run: |
        Write-Host "🚀 Uploading update package to PocketBase..."
        
        $VERSION = "${{ steps.version.outputs.version }}"
        $UPDATE_TYPE = "${{ steps.version.outputs.update_type }}"
        $PACKAGE_PATH = "${{ steps.package.outputs.package_path }}"
        
        # Create update record in PocketBase (implement this based on your PocketBase schema)
        Write-Host "Update package ready for deployment: $PACKAGE_PATH"
        Write-Host "Version: $VERSION"
        Write-Host "Type: $UPDATE_TYPE"
    
    - name: Notify success
      shell: pwsh
      run: |
        Write-Host "🎉 Windows bot update package created successfully!"
        Write-Host "Version: ${{ steps.version.outputs.version }}"
        Write-Host "Package: ${{ steps.package.outputs.package_path }}" 